#!/bin/bash

set -e

git_update="true"
git_status=""
mvn_build=""
init=""
exclude=""
git_fetch="true"
while getopts "bgstife:" OPT;
do
	case $OPT in
		i)
			echo Initializing .pommit_projs
			find . -type d -maxdepth 1 -mindepth 1 -exec echo 'PROJS="$PROJS {}"' ';' \
				| sed -e s_\./__ \
				| tee .pommit_projs
			echo done
			exit 0
			;;
		e)
			exclude="$exclude $OPTARG"
			;;
		b)
			mvn_build="mvn clean install"
			;;
		g)
			git_update="git pull --rebase"
			;;
		f)
			git_fetch="git fetch --quiet"
			;;
		s)
			git_status="git status --short --branch"
			;;
		t)
			git_status="git stash list"
			;;
	esac
done

if [[ -f .pommit_projs ]];
then
	. .pommit_projs
else
	echo "Not initialized."
	exit 1
fi

if [[ ! -z "$git_status" ]];
then
	for pro in $PROJS;
	do
		if [[ $exclude == *"$pro"* ]];
		then
			echo $pro excluded
			continue
		fi
		(cd $pro && pwd && $git_fetch && $git_status && echo -e "")
	done
	exit 1
fi

for pro in $PROJS; 
do
	(cd $pro && $git_update && $mvn_build)
done
